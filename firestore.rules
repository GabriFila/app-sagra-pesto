rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    allow read: if false;
    allow write: if false;
      match /sagre/{sagraId} {
        allow read: if false;
  			allow write: if false;
        match /storage/{storageid} {
        	allow get: if hasRole('admin') || hasRole("cassa") || hasRole("cassa-istantanea");
          allow list: if false;
          allow create: if false;
          allow update: if hasRole('admin') && checkFields(['storageCourses'], []);
          allow delete: if false;
        }
      	match /services/{serviceId} {
    			allow get: if hasRole('admin');
    			allow list: if hasRole('admin') || hasRole("cassa") || hasRole("cassa-istantanea") || hasRole("sala") ;
          allow create: if hasRole('admin') && checkFields(['end', 'lastOrderNum','startingCourses', 'start', 'totalInstantOrders', 'totalInstantRevenue', 'totalOrders', 'totalPeople', 'totalRevenue'],[]);
          allow update: if hasRole('admin') && editOnlyCertainFields(['end']) 
          allow delete: if false;
          match /orders/{orderId} {
            allow get: if false;
            allow list: if hasRole('sala');
            allow create: if false;
            allow update: if orderCanBeUpdatedByWaiter();
            allow delete: if false;
          }
          match /courses/{courseId} {
            allow get: if false;
            allow list: if hasRole('sala');
            allow write: if false;
            allow create: if false;
            allow update: if (hasRole('sala') && (!resource.data.keys().hasAll(["waiterId"]) && editOnlyCertainFields(["waiterId"])
                                                        || resource.data["waiterId"] == request.auth.uid && editOnlyCertainFields(["status"])))  || courseCanBeUpdatedByKitchen();
            allow delete: if false;
          }
          match /instantOrders/{instantOrderId} {
            allow get: if false;
            allow list: if false;
            allow create: if hasRole('cassa-istantanea') && checkFields(['courses','revenue'],[])
            allow update: if false;
            allow delete: if false;
          }
        }
		  	allow read: if false;
  			allow write: if false;
  
      }
  }
}

function hasRole(reqRole) {
	return request.auth.token[reqRole] == true;
}

function checkFields(requiredFields, optionalFields) {
  let allFields = requiredFields.concat(optionalFields);
  return  request.resource.data.keys().hasAll(requiredFields) && request.resource.data.keys().hasOnly(allFields);
}

function editOnlyCertainFields(editableFields) {
  return request.resource.data.diff(resource.data).affectedKeys().hasOnly(editableFields) && request.resource.data.diff(resource.data).affectedKeys().hasAll(editableFields);
}

function orderCanBeUpdatedByWaiter() {
  return hasRole('sala') && (editOnlyCertainFields(['tableNum',"waiterId","waiterName","status"]) && resource.data["status"] == "pending" || editOnlyCertainFields(["note"]) &&  resource.data["status"] != "pending");
}

function courseCanBeUpdatedByKitchen() {
  return editOnlyCertainFields(["status"]) && resource.data.status == "prep" && request.resource.data.status == "ready" && ((hasRole("cucina-primi") && request.resource.data.kitchen == "Primi") || (hasRole("cucina-secondi") && request.resource.data.kitchen == "Secondi") || (hasRole("cucina-bar") && request.resource.data.kitchen == "Bar"));  
}
